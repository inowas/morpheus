version: "3.8"
services:
  frontend:
    image: inowas/morpheus-frontend:${FRONTEND_VERSION}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend-http.entrypoints=web"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend-http.rule=Host(`${FRONTEND_HOST}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.rule=Host(`${FRONTEND_HOST}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.tls=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.service=${COMPOSE_PROJECT_NAME}-frontend"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-frontend.loadbalancer.server.port=8080"
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
    networks:
      - traefik
    restart: always
    read_only: true
    tmpfs:
      - /var/run:mode=777,size=100m
      - /var/cache/nginx:mode=777,size=100m
  backend:
    image: inowas/morpheus-backend-api:${BACKEND_VERSION}
    container_name: ${COMPOSE_PROJECT_NAME}-backend
    depends_on:
      mongodb_backend:
        condition: service_healthy
      celery_worker:
        condition: service_healthy
    env_file:
      - .env
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/healthcheck" ]
      interval: 40s
      timeout: 30s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend-http.entrypoints=web"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend-http.rule=Host(`${BACKEND_HOST}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.rule=Host(`${BACKEND_HOST}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.tls=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.service=${COMPOSE_PROJECT_NAME}-backend"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-backend.loadbalancer.server.port=8000"
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
    networks:
      - traefik
      - backend
    read_only: true
    tmpfs:
      - /tmp:mode=777,size=200m
    restart: always
    user: flask
    volumes:
      - morpheus_project_asset_data:${BACKEND_MORPHEUS_PROJECT_ASSET_DATA}:rw
      - morpheus_project_calculation_data:${BACKEND_MORPHEUS_PROJECT_CALCULATION_DATA}:rw
      - morpheus_sensor_data:${BACKEND_MORPHEUS_SENSOR_LOCAL_DATA}:rw
  cron:
    image: inowas/cron:latest
    restart: always
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - BACKEND_CONTAINER_NAME=${COMPOSE_PROJECT_NAME}-backend
    networks:
      - backend
    read_only: true
    volumes:
      #- ./cron/jobs/5min:/etc/periodic/5min:ro
      #- ./cron/jobs/15min:/etc/periodic/15min:ro
      - ./cron/jobs/hourly:/etc/periodic/hourly:ro
      #- ./cron/jobs/daily:/etc/periodic/daily:ro
      #- ./cron/jobs/weekly:/etc/periodic/weekly:ro
      #- ./cron/jobs/monthly:/etc/periodic/monthly:ro
      # inject docker socket
      - /var/run/docker.sock:/var/run/docker.sock
    command: crond -f -l 8
  mongodb_backend:
    image: mongo:7.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${BACKEND_MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${BACKEND_MONGO_INITDB_ROOT_PASSWORD}
    env_file:
      - .env
    volumes:
      - mongodb_backend_data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.runCommand('ping').ok", "--quiet" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - backend
    read_only: true
    user: mongodb
    tmpfs:
      - /tmp
  rabbitmq:
    image: rabbitmq:3.12.9-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_DEFAULT_VHOST}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    read_only: true
    user: rabbitmq
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "check_running" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - backend
      - celery
    hostname:
      ${COMPOSE_PROJECT_NAME}-rabbitmq
    tmpfs:
      - /tmp
  celery_worker:
    image: inowas/morpheus-backend-task-queue-worker:${BACKEND_VERSION}
    container_name: ${COMPOSE_PROJECT_NAME}-celery_worker
    depends_on:
      mongodb_backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - morpheus_project_calculation_data:${BACKEND_MORPHEUS_PROJECT_CALCULATION_DATA}:rw
    tmpfs:
      - /tmp
    restart: always
    user: celery
    read_only: true
    networks:
      - backend
      - celery
    healthcheck:
      test: [ "CMD", "celery", "-A", "task_queue", "inspect", "ping"]
      interval: 5s
      timeout: 5s
      start_period: 30s
      retries: 5

volumes:
  mongodb_backend_data:
    driver: local
  morpheus_project_asset_data:
    driver: local
  morpheus_project_calculation_data:
    driver: local
  morpheus_sensor_data:
    driver: local
  postgres_backend_data:
    driver: local
  rabbitmq_data:
    driver: local

networks:
  backend:
    name: ${COMPOSE_PROJECT_NAME}-backend
  celery:
    name: ${COMPOSE_PROJECT_NAME}-celery
  traefik:
    name: ${TRAEFIK_NETWORK}
    external: true
